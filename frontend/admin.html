<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Panel - Paired Devices</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: system-ui, -apple-system, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: #fff;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .header p {
      font-size: 14px;
      opacity: 0.9;
    }

    /* Statistics Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .stat-card .icon {
      font-size: 36px;
      margin-bottom: 12px;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
      color: #333;
      margin-bottom: 4px;
    }

    .stat-card .label {
      font-size: 14px;
      color: #666;
      font-weight: 500;
    }

    /* Devices Section */
    .devices-section {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .devices-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #f0f0f0;
    }

    .devices-header h2 {
      font-size: 24px;
      color: #333;
    }

    .refresh-btn {
      background: #667eea;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .refresh-btn:hover {
      background: #5568d3;
    }

    /* Device Table */
    .device-table {
      width: 100%;
      border-collapse: collapse;
    }

    .device-table thead {
      background: #f8f9fa;
    }

    .device-table th {
      text-align: left;
      padding: 12px 16px;
      font-size: 12px;
      font-weight: 700;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .device-table td {
      padding: 16px;
      border-top: 1px solid #f0f0f0;
      color: #333;
      font-size: 14px;
    }

    .device-table tbody tr {
      transition: background 0.2s;
      cursor: pointer;
    }

    .device-table tbody tr:hover {
      background: #f8f9fa;
      transform: scale(1.01);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .device-name {
      font-weight: 600;
      color: #333;
    }

    .device-icon {
      font-size: 20px;
      margin-right: 8px;
      vertical-align: middle;
    }

    /* Status Badge */
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-active {
      background: #d4edda;
      color: #155724;
    }

    .status-inactive {
      background: #e2e3e5;
      color: #383d41;
    }

    /* File Counts */
    .file-count {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-weight: 600;
    }

    .file-count .icon {
      font-size: 16px;
    }

    /* Actions */
    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-right: 8px;
    }

    .btn-view {
      background: #e3f2fd;
      color: #1976d2;
    }

    .btn-view:hover {
      background: #bbdefb;
    }

    .btn-revoke {
      background: #ffebee;
      color: #c62828;
    }

    .btn-revoke:hover {
      background: #ffcdd2;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state .icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .empty-state h3 {
      font-size: 20px;
      margin-bottom: 8px;
      color: #333;
    }

    .empty-state p {
      font-size: 14px;
      color: #666;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .device-table {
        font-size: 12px;
      }

      .device-table th,
      .device-table td {
        padding: 8px;
      }

      .devices-header {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
      }
    }

    /* Time Display */
    .time-text {
      font-size: 12px;
      color: #999;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üì± Admin Panel</h1>
      <p>Manage paired devices and monitor activity</p>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="icon">üì±</div>
        <div class="value" id="stat-total">0</div>
        <div class="label">Total Devices</div>
      </div>

      <div class="stat-card">
        <div class="icon">üü¢</div>
        <div class="value" id="stat-active">0</div>
        <div class="label">Active Devices</div>
      </div>

      <div class="stat-card">
        <div class="icon">üì∏</div>
        <div class="value" id="stat-photos">0</div>
        <div class="label">Total Photos</div>
      </div>

      <div class="stat-card">
        <div class="icon">üé•</div>
        <div class="value" id="stat-videos">0</div>
        <div class="label">Total Videos</div>
      </div>
    </div>

    <!-- Devices Table -->
    <div class="devices-section">
      <div class="devices-header">
        <h2>Paired Devices</h2>
        <div style="display: flex; gap: 10px;">
          <button class="refresh-btn" onclick="cleanupInactive()" style="background: #dc3545;">
            üóëÔ∏è Cleanup Inactive
          </button>
          <button class="refresh-btn" onclick="loadDevices()">üîÑ Refresh</button>
        </div>
      </div>

      <div id="devices-content">
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>Loading devices...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    let autoRefreshInterval = null;

    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatTime(isoString) {
      if (!isoString) return 'Never';
      const date = new Date(isoString);
      const now = new Date();
      const diff = (now - date) / 1000; // seconds

      if (diff < 60) return 'Just now';
      if (diff < 3600) return Math.floor(diff / 60) + ' min ago';
      if (diff < 86400) return Math.floor(diff / 3600) + ' hrs ago';
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }

    async function loadDevices() {
      try {
        const res = await fetch('/api/admin/paired-devices');
        const data = await res.json();

        // Update statistics
        document.getElementById('stat-total').textContent = data.summary.total_devices;
        document.getElementById('stat-active').textContent = data.summary.active_devices;
        document.getElementById('stat-photos').textContent = data.summary.total_photos;
        document.getElementById('stat-videos').textContent = data.summary.total_videos;

        const content = document.getElementById('devices-content');

        if (!data.devices || data.devices.length === 0) {
          content.innerHTML = `
            <div class="empty-state">
              <div class="icon">üì±</div>
              <h3>No Devices Paired</h3>
              <p>Scan the pairing QR code from your phone to get started</p>
            </div>
          `;
          return;
        }

        // Build table
        let tableHTML = `
          <table class="device-table">
            <thead>
              <tr>
                <th>Device</th>
                <th>Status</th>
                <th>Photos</th>
                <th>Videos</th>
                <th>Total Files</th>
                <th>Last Seen</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
        `;

        data.devices.forEach(device => {
          const statusClass = device.active ? 'status-active' : 'status-inactive';
          const statusText = device.active ? 'üü¢ Active' : '‚ö´ Inactive';

          tableHTML += `
            <tr onclick="viewDevice('${device.token}')" style="cursor: pointer;">
              <td>
                <span class="device-icon">üì±</span>
                <span class="device-name">${device.device_name}</span>
              </td>
              <td>
                <span class="status-badge ${statusClass}">${statusText}</span>
              </td>
              <td>
                <span class="file-count">
                  <span class="icon">üì∏</span>
                  ${device.photo_count}
                </span>
              </td>
              <td>
                <span class="file-count">
                  <span class="icon">üé•</span>
                  ${device.video_count}
                </span>
              </td>
              <td>${device.total_files} (${formatBytes(device.total_size)})</td>
              <td class="time-text">${formatTime(device.last_seen)}</td>
              <td onclick="event.stopPropagation()">
                <button class="action-btn btn-view" onclick="viewDevice('${device.token}')">
                  üëÅÔ∏è View
                </button>
                <button class="action-btn btn-revoke" onclick="revokeDevice('${device.token}', '${device.device_name}')">
                  üóëÔ∏è Revoke
                </button>
              </td>
            </tr>
          `;
        });

        tableHTML += `
            </tbody>
          </table>
        `;

        content.innerHTML = tableHTML;

      } catch (e) {
        console.error('Error loading devices:', e);
        document.getElementById('devices-content').innerHTML = `
          <div class="empty-state">
            <div class="icon">‚ö†Ô∏è</div>
            <h3>Error Loading Devices</h3>
            <p>${e.message}</p>
          </div>
        `;
      }
    }

    function viewDevice(token) {
      window.location.href = `/explorer/${token}`;
    }

    async function revokeDevice(token, deviceName) {
      if (!confirm(`Are you sure you want to revoke access for "${deviceName}"?`)) {
        return;
      }

      try {
        const res = await fetch(`/api/pairing/revoke/${token}`, {
          method: 'POST'
        });

        const data = await res.json();

        if (data.ok) {
          alert('Device access revoked successfully');
          loadDevices();
        } else {
          alert('Error: ' + (data.error || 'Unknown error'));
        }
      } catch (e) {
        alert('Error revoking device: ' + e.message);
      }
    }

    async function cleanupInactive() {
      const days = prompt('Remove devices inactive for how many days?', '30');

      if (!days) return;

      const daysNum = parseInt(days);
      if (isNaN(daysNum) || daysNum < 1) {
        alert('Please enter a valid number of days');
        return;
      }

      if (!confirm(`Remove all devices inactive for more than ${daysNum} days?`)) {
        return;
      }

      try {
        const res = await fetch('/api/admin/cleanup-inactive', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ days: daysNum })
        });

        const data = await res.json();

        if (data.ok) {
          alert(data.message);
          loadDevices();
        } else {
          alert('Error: ' + (data.error || 'Unknown error'));
        }
      } catch (e) {
        alert('Error cleanup: ' + e.message);
      }
    }

    // Auto-cleanup on page load (30 days)
    async function autoCleanup() {
      try {
        await fetch('/api/admin/cleanup-inactive', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ days: 30 })
        });
      } catch (e) {
        console.log('Auto-cleanup skipped:', e.message);
      }
    }

    // Initial load
    autoCleanup();  // Run cleanup first
    loadDevices();

    // Auto-refresh every 5 seconds
    autoRefreshInterval = setInterval(loadDevices, 5000);

    // Stop auto-refresh when page is hidden
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        clearInterval(autoRefreshInterval);
      } else {
        loadDevices();
        autoRefreshInterval = setInterval(loadDevices, 5000);
      }
    });
  </script>
</body>

</html>