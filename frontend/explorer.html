<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>File Explorer</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#0f1419; color:#e6eef8; font-family:system-ui; min-height:100vh; }
    .container { max-width:1200px; margin:0 auto; padding:20px; }
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; }
    h1 { font-size:28px; color:#fff; }
    .back-btn { background:#444; color:#fff; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; }
    .back-btn:hover { background:#555; }
    
    .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:20px; margin-bottom:40px; }
    
    .folder, .file { background:#1a2332; border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:20px; cursor:pointer; transition:all 0.2s; }
    .folder:hover, .file:hover { background:#232f40; border-color:rgba(110,168,254,0.3); transform:translateY(-2px); }
    
    .icon { font-size:48px; margin-bottom:12px; }
    .name { font-weight:600; color:#fff; word-break:break-word; }
    .meta { font-size:12px; color:#aaa; margin-top:8px; }
    
    .gallery { display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:15px; margin-bottom:40px; }
    .gallery-item { position:relative; border-radius:8px; overflow:hidden; aspect-ratio:1; cursor:pointer; background:#1a2332; border:1px solid rgba(255,255,255,0.1); }
    .gallery-item img { width:100%; height:100%; object-fit:cover; transition:transform 0.2s; }
    .gallery-item:hover { border-color:rgba(110,168,254,0.5); }
    .gallery-item:hover img { transform:scale(1.05); }
    .gallery-item-name { position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,0.7); padding:8px; font-size:11px; color:#fff; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .video-badge { position:absolute; top:8px; right:8px; background:rgba(0,0,0,0.7); color:#fff; padding:4px 8px; border-radius:4px; font-size:11px; }
    
    .section-title { font-size:20px; font-weight:600; margin-bottom:20px; color:#fff; }
    .panel { background:#1a2332; border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:20px; margin-bottom:30px; }
    
    .upload-btn { background:#0069ff; color:#fff; border:none; padding:12px 24px; border-radius:6px; cursor:pointer; font-weight:600; font-size:14px; }
    .upload-btn:hover { background:#0057e6; }
    
    .loading { text-align:center; padding:40px; color:#666; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üì± File Explorer</h1>
      <div style="display:flex; gap:10px;">
        <button class="back-btn" onclick="window.location.href='/pairing'" style="background:#6ea8fe; color:#fff;">üîó Pair Device</button>
        <button class="back-btn" onclick="window.location.href='/admin'">‚Üê Back to Admin</button>
      </div>
    </div>
    
    <!-- Synced Devices Section -->
    <div class="panel" id="synced-devices-panel" style="background:#0d5a40; border-color:rgba(76,175,80,0.3); display:none;">
      <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
        <div style="font-size:24px;">üîÑ</div>
        <div>
          <div class="section-title" style="margin:0; color:#81c784;">Local Network Sync</div>
          <p style="color:#a5d6a7; margin-top:4px; font-size:12px;">Files synced from paired devices</p>
        </div>
      </div>
      <div id="synced-devices-list" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:15px;">
        <!-- Synced devices will be listed here -->
      </div>
    </div>
    
    <!-- Request Storage Access (Mobile) -->
    <div class="panel" id="storage-request" style="background:#1a3a52; border-color:rgba(110,168,254,0.3); margin-bottom:30px; display:none;">
      <div style="display:flex; align-items:center; gap:15px;">
        <div style="font-size:24px;">üîì</div>
        <div>
          <div class="section-title" style="margin:0; color:#6ea8fe;">Request Phone Storage Access</div>
          <p style="color:#aaa; margin-top:8px; font-size:13px;">Allow this app to access your phone's photos, videos, and files</p>
        </div>
        <button class="upload-btn" onclick="requestPhoneStorage()" style="margin-left:auto; min-width:120px;">Allow Access</button>
      </div>
    </div>
    
    <!-- Quick Access Folders -->
    <div class="section-title">üìÇ Quick Access</div>
    <div class="grid" id="folders">
      <div class="folder" onclick="goToFolder('DCIM')">
        <div class="icon">üì∑</div>
        <div class="name">DCIM</div>
        <div class="meta">Camera Photos</div>
      </div>
      <div class="folder" onclick="goToFolder('Downloads')">
        <div class="icon">‚¨áÔ∏è</div>
        <div class="name">Downloads</div>
        <div class="meta">Downloaded Files</div>
      </div>
      <div class="folder" onclick="goToFolder('Documents')">
        <div class="icon">üìÑ</div>
        <div class="name">Documents</div>
        <div class="meta">User Documents</div>
      </div>
      <div class="folder" onclick="goToFolder('Music')">
        <div class="icon">üéµ</div>
        <div class="name">Music</div>
        <div class="meta">Audio Files</div>
      </div>
      <div class="folder" onclick="goToFolder('Pictures')">
        <div class="icon">üñºÔ∏è</div>
        <div class="name">Pictures</div>
        <div class="meta">Gallery Images</div>
      </div>
      <div class="folder" onclick="goToFolder('Videos')">
        <div class="icon">üé¨</div>
        <div class="name">Videos</div>
        <div class="meta">Video Files</div>
      </div>
    </div>
    
    <!-- Gallery View -->
    <div class="panel">
      <div class="section-title">üñºÔ∏è Gallery - Photos & Videos</div>
      <div class="gallery" id="gallery">
        <div class="loading">Loading gallery...</div>
      </div>
    </div>
    
    <!-- Current Folder Files -->
    <div class="panel">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <div class="section-title" style="margin:0;">üìã Files in <span id="current-folder">DCIM</span></div>
        <button class="upload-btn" onclick="uploadFile()">‚¨ÜÔ∏è Upload File</button>
      </div>
      <div class="grid" id="files">
        <div class="loading">Loading files...</div>
      </div>
    </div>
    
    <!-- File Details -->
    <div class="panel">
      <div class="section-title">‚ÑπÔ∏è File Information</div>
      <table style="width:100%; border-collapse:collapse;">
        <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
          <td style="padding:12px; color:#aaa;">Filename</td>
          <td style="padding:12px;" id="info-name">-</td>
        </tr>
        <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
          <td style="padding:12px; color:#aaa;">Size</td>
          <td style="padding:12px;" id="info-size">-</td>
        </tr>
        <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
          <td style="padding:12px; color:#aaa;">Type</td>
          <td style="padding:12px;" id="info-type">-</td>
        </tr>
        <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
          <td style="padding:12px; color:#aaa;">Modified</td>
          <td style="padding:12px;" id="info-date">-</td>
        </tr>
        <tr>
          <td style="padding:12px; color:#aaa;">Location</td>
          <td style="padding:12px;" id="info-path">-</td>
        </tr>
      </table>
    </div>
  </div>
  
  <script>
    const token = "{{ token }}";
    let currentFolder = 'DCIM';
    let selectedFiles = []; // locally-selected File objects and metadata
    let currentSelectedName = null;
    
    // Sample gallery data
    const sampleGallery = [
      { name: 'IMG_20241220_143022.jpg', type: 'image', size: 2456789 },
      { name: 'IMG_20241220_143115.jpg', type: 'image', size: 3112456 },
      { name: 'IMG_20241219_092543.jpg', type: 'image', size: 2834567 },
      { name: 'IMG_20241218_165432.jpg', type: 'image', size: 2654321 },
      { name: 'SCREENSHOT_20241220.png', type: 'image', size: 1523456 },
      { name: 'IMG_20241217_184530.jpg', type: 'image', size: 3345678 },
      { name: 'VID_20241220_143145.mp4', type: 'video', size: 47364829 },
      { name: 'VID_20241219_091200.mp4', type: 'video', size: 52847362 },
    ];
    
    // Generate random color for placeholder
    function getColorForFile(name) {
      const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F'];
      let hash = 0;
      for (let i = 0; i < name.length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
      }
      return colors[Math.abs(hash) % colors.length];
    }
    
    // Create placeholder image
    function createPlaceholderImage(name, type) {
      const canvas = document.createElement('canvas');
      canvas.width = 200;
      canvas.height = 200;
      const ctx = canvas.getContext('2d');
      const color = getColorForFile(name);
      
      ctx.fillStyle = color;
      ctx.fillRect(0, 0, 200, 200);
      
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 48px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      const icon = type === 'image' ? 'üñºÔ∏è' : 'üé¨';
      ctx.fillText(icon, 100, 100);
      
      return canvas.toDataURL();
    }
    
    async function loadGallery() {
      try {
        const res = await fetch(`/api/gallery/${token}`);
        const data = await res.json();
        
        let files = data.gallery || [];
        if (files.length === 0) {
          files = sampleGallery;
        }
        
        const gallery = document.getElementById('gallery');
        if (files.length === 0) {
          gallery.innerHTML = '<p style="color:#666; grid-column:1/-1; text-align:center; padding:40px;">No images or videos</p>';
          return;
        }
        
        gallery.innerHTML = files.map(f => {
          const isVideo = f.type === 'video';
          const placeholder = createPlaceholderImage(f.name, f.type);
          const srcUrl = f.path || placeholder;
          return `
            <div class="gallery-item" onclick="selectFile('${f.name}', ${f.size}, '${f.type}'); viewGalleryImage('${srcUrl}');" title="${f.name}">
              ${isVideo ? '<div class="video-badge">üé¨ Video</div>' : ''}
              <img src="${srcUrl}" alt="${f.name}" onerror="this.src='${placeholder}'" style="cursor:pointer;">
              <div class="gallery-item-name">${f.name}</div>
            </div>
          `;
        }).join('');
      } catch(e) {
        console.error(e);
        document.getElementById('gallery').innerHTML = '<p style="color:#f00;">Error loading gallery</p>';
      }
    }
    
    // Load synced devices from local network
    async function loadSyncedDevices() {
      try {
        const res = await fetch('/api/pairing/devices');
        const data = await res.json();
        
        if (data.devices && data.devices.length > 0) {
          document.getElementById('synced-devices-panel').style.display = 'block';
          const list = document.getElementById('synced-devices-list');
          
          list.innerHTML = data.devices.map(dev => `
            <div class="file" style="background:#1b4332; border-color:#52b788;">
              <div class="icon">üì±</div>
              <div class="name">${dev.phone_device_name || 'Phone'}</div>
              <div class="meta" style="color:#a5d6a7;">
                ${(dev.synced_files || []).length} files synced<br>
                <small>${dev.last_sync ? new Date(dev.last_sync).toLocaleString() : 'Never'}</small>
              </div>
            </div>
          `).join('');
        }
      } catch(e) {
        console.warn('Could not load synced devices:', e);
      }
    }
    
    function viewGalleryImage(imageSrc) {
      // Open image in full screen lightbox
      const modal = document.createElement('div');
      modal.style.cssText = `
        position:fixed; top:0; left:0; right:0; bottom:0;
        background:rgba(0,0,0,0.9); display:flex; align-items:center;
        justify-content:center; z-index:10000; cursor:pointer;
      `;
      
      const img = document.createElement('img');
      img.src = imageSrc;
      img.style.cssText = 'max-width:90vw; max-height:90vh; object-fit:contain;';
      
      modal.appendChild(img);
      modal.onclick = () => document.body.removeChild(modal);
      document.body.appendChild(modal);
    }
    
    // ----- Photo Picker / Storage Access Helpers -----
    async function requestPhoneStorage() {
      // Prefer the modern Photo Picker / File System Access when available
      if (window.showOpenFilePicker) {
        try {
          await openPhotoPicker();
          document.getElementById('storage-request').style.display = 'none';
        } catch (e) {
          console.warn('Photo Picker cancelled or failed', e);
          fallbackFileInput();
        }
      } else {
        // Fallback to input[type=file]
        fallbackFileInput();
      }
    }

    async function openPhotoPicker() {
      // Ask for images and videos
      const handles = await window.showOpenFilePicker({
        multiple: true,
        types: [
          { description: 'Images', accept: { 'image/*': ['.png', '.jpg', '.jpeg', '.webp'] } },
          { description: 'Videos', accept: { 'video/*': ['.mp4', '.mov', '.webm'] } }
        ]
      });

      const files = [];
      for (const handle of handles) {
        try {
          const f = await handle.getFile();
          files.push(f);
        } catch (e) {
          console.warn('Could not get file from handle', e);
        }
      }
      if (files.length) processSelectedFiles(files);
    }

    function fallbackFileInput() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*,video/*';
      input.multiple = true;
      input.capture = 'environment';
      input.onchange = (e) => {
        const files = Array.from(e.target.files || []);
        processSelectedFiles(files);
      };
      input.click();
    }

    async function processSelectedFiles(files) {
      // Add to local selectedFiles and show previews in gallery
      const gallery = document.getElementById('gallery');
      const toShow = [];

      for (const file of files) {
        const isVideo = file.type && file.type.startsWith('video');
        const obj = { name: file.name, size: file.size, type: isVideo ? 'video' : 'image', file };
        selectedFiles.push(obj);

        // create object URL for preview
        const url = URL.createObjectURL(file);
        toShow.push({ name: file.name, size: file.size, type: obj.type, url });

        // upload the file to server so admin/gallery sees it
        try {
          const fd = new FormData();
          fd.append('file', file, file.name);
          await fetch(`/api/storage/upload/${token}`, { method: 'POST', body: fd });
        } catch (e) {
          console.warn('Upload failed for', file.name, e);
        }
      }

      // Prepend previews to gallery
      const html = toShow.map(f => {
        const badge = f.type === 'video' ? '<div class="video-badge">üé¨ Video</div>' : '';
        return `
          <div class="gallery-item" onclick="selectFile('${escapeHtml(f.name)}', ${f.size}, '${f.type}')">
            ${badge}
            <img src="${f.url}" alt="${escapeHtml(f.name)}">
            <div class="gallery-item-name">${escapeHtml(f.name)}</div>
          </div>
        `;
      }).join('');

      // Remove loading message if present
      if (gallery.querySelector('.loading')) gallery.innerHTML = '';
      gallery.insertAdjacentHTML('afterbegin', html);
      loadGallery(); // refresh from server gallery as well
    }

    function escapeHtml(s) {
      return (s+'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot',"'":'&#39'}[c]));
    }

    // Web Share / Nearby Share helper
    async function shareSelectedFile(name) {
      const entry = selectedFiles.find(f => f.name === name) || null;
      if (!entry) return alert('File not available for sharing');

      // navigator.share supports File objects in some browsers
      if (navigator.canShare && navigator.canShare({ files: [entry.file] })) {
        try {
          await navigator.share({ files: [entry.file], title: entry.name });
          return;
        } catch (e) {
          console.warn('Share failed', e);
        }
      }

      // Fallback: open the file in a new tab (object URL)
      const url = URL.createObjectURL(entry.file);
      window.open(url, '_blank');
    }
    
    function goToFolder(folder) {
      currentFolder = folder;
      document.getElementById('current-folder').textContent = folder;
      
      const folderFiles = {
        'DCIM': [
          { name: 'IMG_20241220_143022.jpg', size: 2456789, type: 'image' },
          { name: 'IMG_20241220_143115.jpg', size: 3112456, type: 'image' },
          { name: 'VID_20241220_143145.mp4', size: 47364829, type: 'video' }
        ],
        'Pictures': [
          { name: 'Vacation_2024.jpg', size: 2234567, type: 'image' },
          { name: 'Family_Photo.png', size: 1876543, type: 'image' },
          { name: 'Sunset.jpg', size: 2654321, type: 'image' }
        ],
        'Videos': [
          { name: 'Trip_2024.mp4', size: 52847362, type: 'video' },
          { name: 'Birthday_Party.mp4', size: 48234567, type: 'video' }
        ],
        'Downloads': [
          { name: 'document.pdf', size: 512000, type: 'document' },
          { name: 'image.png', size: 1200000, type: 'image' }
        ],
        'Documents': [
          { name: 'notes.txt', size: 24000, type: 'document' },
          { name: 'report.pdf', size: 1800000, type: 'document' }
        ],
        'Music': [
          { name: 'song1.mp3', size: 4200000, type: 'audio' },
          { name: 'song2.mp3', size: 3800000, type: 'audio' }
        ]
      };
      
      const files = folderFiles[folder] || [];
      const filesDiv = document.getElementById('files');
      
      if (files.length === 0) {
        filesDiv.innerHTML = '<p style="color:#666; grid-column:1/-1; text-align:center; padding:40px;">No files in this folder</p>';
        return;
      }
      
      filesDiv.innerHTML = files.map(f => {
        const icons = { 'image': 'üñºÔ∏è', 'video': 'üé¨', 'audio': 'üéµ', 'document': 'üìÑ' };
        const icon = icons[f.type] || 'üìÑ';
        return `
          <div class="file" onclick="selectFile('${f.name}', ${f.size}, '${f.type}')">
            <div class="icon">${icon}</div>
            <div class="name">${f.name}</div>
            <div class="meta">${(f.size / 1024 / 1024).toFixed(1)} MB</div>
          </div>
        `;
      }).join('');
    }
    
    function selectFile(name, size, type) {
      document.getElementById('info-name').textContent = name;
      document.getElementById('info-size').textContent = (size / 1024 / 1024).toFixed(2) + ' MB';
      const typeMap = { 'image': 'Image/JPEG', 'video': 'Video/MP4', 'audio': 'Audio/MP3', 'document': 'Document/PDF' };
      document.getElementById('info-type').textContent = typeMap[type] || type;
      document.getElementById('info-date').textContent = new Date().toLocaleString();
      document.getElementById('info-path').textContent = `/storage/emulated/0/${currentFolder}/${name}`;
    }
    
    function uploadFile() {
      const input = document.createElement('input');
      input.type = 'file';
      input.multiple = true;
      input.onchange = (e) => {
        const files = e.target.files;
        for (let file of files) {
          const formData = new FormData();
          formData.append('file', file);
          
          fetch(`/api/storage/upload/${token}`, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
              alert('File uploaded: ' + file.name);
              loadGallery();
            })
            .catch(err => console.error(err));
        }
      };
      input.click();
    }
    
    loadGallery();
    loadSyncedDevices();
    goToFolder('DCIM');
    
    // Poll synced devices every 5 seconds
    setInterval(loadSyncedDevices, 5000);
  </script>
</body>
</html>
